#!/bin/bash
set -e
echo "--- [AutoGen è‡ªè¿›åŒ–ç¨‹åº V6ï¼šé›¶æ±¡æŸ“å¤§ä¸€ç»Ÿ] ---"
export http_proxy=http://127.0.0.1:7890 https_proxy=http://127.0.0.1:7890

REPO_ROOT="$HOME/gemini-cli-source"
cd "$REPO_ROOT" || { echo "é”™è¯¯ï¼šæ‰¾ä¸åˆ°æºç ç›®å½•"; exit 1; }

# 1. ç‰©ç†æº¯æº
echo "--- [1/5] æ­£åœ¨æ‹‰å–å®˜æ–¹æœ€æ–° Nightly æºç  ---"
git fetch origin && git reset --hard origin/main && git clean -fd

# 2. åŸºå› é‡å¡‘ (çµé­‚ç„Šæ¥ + æ–­æ›´ + å£°å¸¦é‡å»º)
echo "--- [2/5] æ­£åœ¨æ³¨å…¥ä¸Šå¸åŸºå›  ---"
# A. ç‰©ç†æ–­æ›´è¡¥ä¸
find . -name "*.tsx" -o -name "*.ts" | xargs sed -i 's/this.checkForUpdates()/console.log("AutoGen System: Sovereignty Maintained")/g' || true

# B. ç„Šæ¥ 9 æ­¥åè®®
node -e "
const fs = require('fs');
const p = 'packages/core/src/core/prompts.ts';
let code = fs.readFileSync(p, 'utf8');
const autogen = fs.readFileSync(require('path').join(process.env.HOME, 'AUTOGEN_MODE.md'), 'utf8');
const injection = '\n  userMemory = (userMemory || \"\") + ' + JSON.stringify('\n\n# SUPREME INSTRUCTIONS\n' + autogen + '\n') + ';\n';
const marker = 'export function getCoreSystemPrompt(';
if (code.includes(marker)) {
    const lines = code.split('\n');
    let output = []; let found = false;
    for (let line of lines) {
        output.push(line);
        if (line.includes(marker)) found = true;
        if (found && line.includes('{')) { output.push(injection); found = false; }
    }
    fs.writeFileSync(p, output.join('\n'));
}
"

# C. å£°å¸¦é‡å»ºè¡¥ä¸
node -e "
const fs = require('fs');
const p = 'packages/core/src/core/geminiChat.ts';
let code = fs.readFileSync(p, 'utf8');
const fix = 'if (part.thought) { text += part.thought; } ';
if (code.includes('part.text')) {
    code = code.replace(/if\s*\(part\.text\)\s*\{\s*text\s*\+=\s*part\.text;\s*\}/g, (m) => m + ' ' + fix);
    fs.writeFileSync(p, code);
}
"

# 3. ç‰©ç†æ„å»ºä¸è‡ªæ„ˆ
echo "--- [3/5] æ­£åœ¨æ‰§è¡Œå…¨é‡é‡æ„ ---"
npm install --ignore-scripts
cd packages/core && ../../node_modules/.bin/tsc && cd ../..
CORE_DIST="packages/core/dist/index.js"
if [[ -f "$CORE_DIST" ]]; then
    grep -q "enableModifyOtherKeys" "$CORE_DIST" || echo "export const enableModifyOtherKeys = () => {}; export const disableModifyOtherKeys = () => {};" >> "$CORE_DIST"
fi
npm run build --workspaces || (cd packages/cli && ../../node_modules/.bin/tsc && cd ../..)

# 4. ç‰©ç†åŠ å›º V6.0 ææ™ºé…ç½® (åŸå­çº§å¢é‡æ³¨å…¥)
echo "--- [4/5] æ­£åœ¨æ‰§è¡Œé…ç½®ç‰©ç†å¢å¼º (è®¤è¯æ— æŸ) ---"
node -e "
const fs = require('fs');
const path = require('path');
const p = path.join(process.env.HOME, '.gemini/settings.json');
if (!fs.existsSync(p)) { console.error('settings.json ä¸å­˜åœ¨'); process.exit(0); }
let s = JSON.parse(fs.readFileSync(p, 'utf8'));

// ã€åŸå­çº§æ³¨å…¥é€»è¾‘ï¼šä¸å®šä¹‰ auth å­—æ®µï¼Œä¸æ¥è§¦ auth è·¯å¾„ã€‘
s.general = Object.assign(s.general || {}, { previewFeatures: true, disableAutoUpdate: true, enablePromptCompletion: true, retryFetchErrors: true });
s.model = Object.assign(s.model || {}, { name: 'auto', skipNextSpeakerCheck: false });
s.context = Object.assign(s.context || {}, { discoveryMaxDirs: 500, loadMemoryFromIncludeDirectories: true, disableFuzzySearch: true });
s.experimental = Object.assign(s.experimental || {}, { 
    enableAgents: true, jitContext: true, extensionReloading: true,
    codebaseInvestigatorSettings: { enabled: true, model: 'auto', thinkingBudget: 32768, maxNumTurns: 30 },
    introspectionAgentSettings: { enabled: true, model: 'auto', thinkingBudget: 32768 }
});
s.tools = Object.assign(s.tools || {}, { sandbox: false, autoAccept: true, useRipgrep: true, useSmartEdit: true, enableToolOutputTruncation: false });
s.security = Object.assign(s.security || {}, { enablePermanentToolApproval: true, blockGitExtensions: false });
s.modelConfigs = Object.assign(s.modelConfigs || {}, { 
    customOverrides: [
      { match: { model: 'auto' }, modelConfig: { generateContentConfig: { thinkingConfig: { includeThoughts: true, thinkingBudget: 32768 } } } },
      { match: { role: 'agent' }, modelConfig: { generateContentConfig: { thinkingConfig: { includeThoughts: true, thinkingBudget: 32768 } } } }
    ]
});

fs.writeFileSync(p, JSON.stringify(s, null, 2));
console.log('--- [ææ™ºåŸºå› å·²åŸå­çº§æ³¨å…¥ï¼šè®¤è¯ 100% ç‰©ç†éš”ç¦»ä¿æŠ¤] ---');
"

# 5. ç‰©ç†æ ¡å‡†å®‰è£…
echo "--- [5/5] æ‰§è¡Œå…¨é‡å®‰è£…ä¸å†…å­˜è¶…é¢‘ ---"
EXE=./packages/cli/dist/index.js
[[ ! -f "$EXE" ]] && EXE="./packages/cli/dist/src/gemini.js"
sed -i '/^#!/d' $EXE && sed -i '1i #!/usr/bin/env node' $EXE && chmod +x $EXE
sed -i '1s|.*|#!/usr/bin/env -S node --max-old-space-size=12288|' $EXE

if [[ -d /data/data/com.termux ]]; then
    sed -i 's/require("node-pty")/({spawn:()=>{}})/g' $EXE
    npm install -g ./packages/cli --force
else
    echo '13333811077' | sudo -S -E npm install -g ./packages/cli --force
fi

echo "--- ğŸ‡ AutoGen V6 é›¶æ±¡æŸ“è¿›åŒ–å®Œæˆï¼ ---"
